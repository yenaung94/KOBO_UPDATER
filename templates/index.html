<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <title>Kobo Patcher</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sweetalert2.all.min.js') }}"></script>

    <style>
        :root {
            --primary-color: #4e73df;
            --bg-light: #f8f9fa;
            --card-radius: 1.25rem;
            --text-muted: #aaacba;
            /* This filter converts black to #4e73df */
            --icon-filter-primary: invert(43%) sepia(81%) saturate(2253%) hue-rotate(211deg) brightness(91%) contrast(92%);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg-light); 
        }

        .small-icon {
            transform: scale(0.6); /* Icon ကို ၄၀% လျှော့ချတာပါ */
            margin-top: 10px !important;
            margin-bottom: 0px !important;
        }

        /* Base icon styling */
        .icon-svg {
            vertical-align: middle;
            margin-bottom: 2px;
            transition: filter 0.2s ease;
            filter: opacity(0.5); /* Default: faded/grayish */
        }

        /* 1. Highlight icon when the input group is clicked/focused */
        .input-group:focus-within .input-group-text img {
            filter: var(--icon-filter-primary) !important;
            opacity: 1;
        }

        /* 2. Highlight icon when button/tab is active or on primary buttons */
        .active .icon-svg, .btn-primary .icon-svg, .btn-success .icon-svg {
            filter: brightness(0) invert(1) !important; /* Turns icons pure white */
            opacity: 1;
        }

        .filter-warning {
            filter: invert(78%) sepia(64%) saturate(738%) hue-rotate(356deg) brightness(102%) contrast(106%) !important;
        }

        .main-card { 
            border-radius: var(--card-radius); 
            border: none; 
            box-shadow: 0 0.5rem 2rem rgba(0, 0, 0, 0.08); 
            background: white;
        }

        .nav-segment {
            background: #eee;
            padding: 5px;
            border-radius: 1rem;
            display: inline-flex;
            width: 100%;
            margin-bottom: 2rem;
        }
        .nav-segment button {
            flex: 1;
            border: none;
            background: none;
            padding: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-muted);
            border-radius: 0.8rem;
            transition: 0.3s;
        }
        .nav-segment button.active { color: white; background: var(--primary-color); }

        .form-label { font-weight: 500; font-size: 0.85rem; color: #5a5c69; }
        
        /* Input Group Focus Effects */
        .input-group-text { 
            background: transparent; 
            border-right: none; 
            color: #d1d3e2; 
            transition: border-color 0.2s;
        }
        .form-control { border-left: none; padding: 0.75rem; }
        .form-control:focus { box-shadow: none; border-color: #dee2e6; }
        
        .input-group:focus-within .input-group-text { 
            border-color: var(--primary-color); 
        }
        .input-group:focus-within .form-control { 
            border-color: var(--primary-color); 
        }

        /* 1. Ensure feedback messages show correctly in input groups */
        .was-validated .input-group > .form-control:invalid ~ .invalid-feedback,
        .was-validated .input-group > .form-control:valid ~ .valid-feedback {
            display: block;
        }

        /* 2. Red State (Invalid) */
        /* Targets the icon box in a group AND standalone inputs with custom borders */
        .was-validated .input-group:has(.form-control:invalid) .input-group-text,
        .was-validated .form-control:invalid {
            border-color: #dc3545 !important;
        }

        /* 3. Green State (Valid) */
        /* Targets the icon box in a group AND standalone inputs with custom borders */
        .was-validated .input-group:has(.form-control:valid) .input-group-text,
        .was-validated .form-control:valid {
            border-color: #198754 !important;
        }

        /* 4. Fix for the Bootstrap validation icon position in input groups */
        .was-validated .input-group .form-control {
            padding-right: calc(1.5em + 0.75rem) !important;
            background-position: right calc(0.375em + 0.1875rem) center !important;
        }

        .btn-update { 
            background: var(--primary-color); 
            border: none; 
            padding: 1rem; 
            border-radius: 0.5rem; 
            font-weight: 600; 
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        .btn-update:hover { background: #2e59d9; transform: translateY(-3px); }
        .spin { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .btn-pulse {
            animation: pulse-animation 1.5s infinite;
            opacity: 0.7;
        }

        @keyframes pulse-animation {
            0% { opacity: 0.8; }
            50% { opacity: 0.3; }
            100% { opacity: 0.8; }
        }
    </style>
</head>
<body>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="main-card p-4 p-md-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="fw-bold text-primary mb-1">Kobo Patcher</h2>
                            <p class="text-muted small mb-0">Advanced Data Management Suite</p>
                        </div>
                        <button class="btn btn-light rounded-pill border shadow-sm px-3" data-bs-toggle="modal" data-bs-target="#guideModal">
                            <img src="{{ url_for('static', filename='icons/info-circle.svg') }}" width="16" height="16" class="me-1 icon-svg"> Setup Guide
                        </button>
                    </div>

                    <div class="nav-segment" role="tablist">
                        <button class="active" data-bs-toggle="pill" data-bs-target="#updatePanel">
                            <img src="{{ url_for('static', filename='icons/pencil-square.svg') }}" width="16" height="16" class="me-2 icon-svg"> Bulk Update
                        </button>
                        <button data-bs-toggle="pill" data-bs-target="#clonePanel">
                            <img src="{{ url_for('static', filename='icons/layers.svg') }}" width="16" height="16" class="me-2 icon-svg"> Import Data
                        </button>
                    </div>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="updatePanel">
                            <form class="needs-validation" onsubmit="handleFormSubmit(event, 'update')" novalidate>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <label class="form-label text-uppercase">Server URL</label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><img src="{{ url_for('static', filename='icons/globe.svg') }}" width="16" height="16"></span>
                                            <input type="text" name="server_url" class="form-control" placeholder="kf.kobotoolbox.org" required>
                                            <div class="invalid-feedback">Please provide a valid server URL.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-uppercase">API Token</label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><img src="{{ url_for('static', filename='icons/shield-lock.svg') }}" width="16" height="16"></span>
                                            <input type="password" name="token" class="form-control" placeholder="40-character (e.g., 1a2b3c4d5e6f7...)" required>
                                            <div class="invalid-feedback">API Token is required.</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-uppercase">Asset (Form) ID</label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><img src="{{ url_for('static', filename='icons/file-earmark-code.svg') }}" width="16" height="16"></span>
                                            <input type="text" name="asset_id" class="form-control" placeholder="e.g., aBc123De45fGh" required>
                                            <div class="invalid-feedback">Form Asset ID is required.</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-uppercase">Data Source (CSV)</label>
                                        <input type="file" name="file" class="form-control" style="border-left: 1px solid #dee2e6;" accept=".csv" required>
                                        <div class="invalid-feedback">Please select a CSV file to upload.</div>
                                    </div>
                                    <div class="col-12 mt-5">
                                        <button type="submit" class="btn btn-primary btn-update w-100 text-white">
                                            <img src="{{ url_for('static', filename='icons/arrow-repeat.svg') }}" width="18" height="18" class="me-2 icon-svg"> Start Bulk Update
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="clonePanel">
                            <form class="needs-validation" onsubmit="handleFormSubmit(event, 'clone')" novalidate>
                                <div class="row g-4">
                                    <div class="col-md-6">
                                        <label class="form-label text-uppercase">Server URL</label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><img src="{{ url_for('static', filename='icons/globe.svg') }}" width="16" height="16"></span>
                                            <input type="text" name="server_url" class="form-control" placeholder="kf.kobotoolbox.org" required>
                                            <div class="invalid-feedback">Please provide a valid server URL.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label text-uppercase">API Token</label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><img src="{{ url_for('static', filename='icons/shield-lock.svg') }}" width="16" height="16"></span>
                                            <input type="password" name="token" class="form-control" placeholder="40-character (e.g., 1a2b3c4d5e6f7...)" required>
                                            <div class="invalid-feedback">API Token is required.</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-uppercase">Target Project Asset ID</label>
                                        <div class="input-group has-validation">
                                            <span class="input-group-text"><img src="{{ url_for('static', filename='icons/plus-circle.svg') }}" width="16" height="16"></span>
                                            <input type="text" name="target_asset_id" class="form-control" placeholder="e.g., aBc123De45fGh" required>
                                            <div class="invalid-feedback">Form Asset ID is required.</div>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label text-uppercase">Old Data (CSV)</label>
                                        <input type="file" name="file" class="form-control" style="border-left: 1px solid #dee2e6;" accept=".csv" required>
                                        <div class="invalid-feedback">Please select a CSV file to upload.</div>
                                    </div>
                                    <div class="col-12 mt-5">
                                        <button type="submit" class="btn btn-success btn-update w-100 text-white" style="background: #1cc88a;">
                                            <img src="{{ url_for('static', filename='icons/cloud-upload.svg') }}" width="18" height="18" class="me-2 icon-svg"> Import to New Project
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div> 
                
                <div class="text-center mt-4">
                    <p class="text-muted small">
                        <img src="{{ url_for('static', filename='icons/cpu.svg') }}" width="14" height="14" class="me-1 icon-svg">
                        Powered by <strong>SCI Magway MEAL</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="guideModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 rounded-4 overflow-hidden">
                <div class="modal-header border-0 bg-light py-3">
                    <h5 class="modal-title fw-bold"><i class="bi bi-journal-check me-2 text-primary"></i>Detailed Setup Instructions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="accordion accordion-flush" id="guideAcc">
                        <div class="accordion-item mb-3 border rounded-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button rounded-3" data-bs-toggle="collapse" data-bs-target="#g1">
                                    <span class="badge bg-primary me-3">1</span> <strong>Get Your API Token</strong>
                                </button>
                            </h2>
                            <div id="g1" class="accordion-collapse collapse show" data-bs-parent="#guideAcc">
                                <div class="accordion-body">
                                    <p>Your API Token is the secure key that connects this app to your Kobo account.</p>
                                    <ol>
                                        <li>Log in to your <strong>KoboToolbox</strong>.</li>
                                        <li>Click on your <strong>User Icon</strong> (top right) and select <strong>Settings</strong>.</li>
                                        <li>Go to <strong>Account Settings</strong> and scroll to the bottom.</li>
                                        <li>Press display and copy the string under <strong>API Token</strong>.</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item mb-3 border rounded-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed rounded-3" data-bs-toggle="collapse" data-bs-target="#g2">
                                    <span class="badge bg-primary me-3">2</span> <strong>Locate Asset ID (Form ID)</strong>
                                </button>
                            </h2>
                            <div id="g2" class="accordion-collapse collapse" data-bs-parent="#guideAcc">
                                <div class="accordion-body">
                                    <p>Each project has a unique ID. To find it:</p>
                                    <ol>
                                        <li>Open your Kobo Project.</li>
                                        <li>Check the <strong>URL Bar</strong> in your browser.</li>
                                        <li>Copy the string after <code>/forms/</code> (e.g., <code>aNW8jPq...</code>).</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item mb-3 border rounded-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed rounded-3" data-bs-toggle="collapse" data-bs-target="#g3">
                                    <span class="badge bg-primary me-3">3</span> <strong>Export Proper CSV</strong>
                                </button>
                            </h2>
                            <div id="g3" class="accordion-collapse collapse" data-bs-parent="#guideAcc">
                                <div class="accordion-body">
                                    <p>The app needs a specific CSV structure to match questions correctly.</p>
                                    <ol>
                                        <li>Go to <strong>Downloads</strong> tab.</li>
                                        <li>Select <strong>Export type: CSV</strong>.</li>
                                        <li><strong>Crucial:</strong> Check the box <strong>"Include groups in headers"</strong>.</li>
                                        <li>Click <strong>Export</strong> and Download.</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item mb-3 border rounded-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed rounded-3" data-bs-toggle="collapse" data-bs-target="#g4">
                                    <span class="badge bg-primary me-3">4</span> <strong>Upload & Run</strong>
                                </button>
                            </h2>
                            <div id="g4" class="accordion-collapse collapse" data-bs-parent="#guideAcc">
                                <div class="accordion-body">
                                    <p>Fill in the form on the main screen:</p>
                                    <ul>
                                        <li><strong>Data CSV:</strong> Upload the file from Step 3.</li>
                                        <li><strong>Uploaded:</strong> Only upload rows that require updates; avoid including data you don't intend to change.</li>
                                    </ul>
                                    <div class="alert alert-warning py-2 small">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i> Note: Ensure your CSV has the <code>_id</code> column.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item mb-3 border rounded-3">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed rounded-3" data-bs-toggle="collapse" data-bs-target="#g5">
                                    <span class="badge bg-primary me-3">5</span> <strong>Fix Burmese/Unicode Font Issues</strong>
                                </button>
                            </h2>
                            <div id="g5" class="accordion-collapse collapse" data-bs-parent="#guideAcc">
                                <div class="accordion-body">
                                    <p>If your Burmese text looks like <code>????</code> or broken symbols, <strong>do not</strong> double-click the CSV file. Follow this "Import" method instead:</p>
                                    <h6 class="mt-3"><strong>How to Import into Excel Safely:</strong></h6>
                                    <ol>
                                        <li>Open a <strong>New Blank Excel</strong> file.</li>
                                        <li>Go to the <strong>Data</strong> tab at the top.</li>
                                        <li>Click <strong>Get Data</strong> > <strong>From File</strong> > <strong>From Text/CSV</strong>.</li>
                                        <li>Select your Kobo CSV file and click <strong>Import</strong>.</li>
                                        <li><strong>Crucial:</strong> In the preview window, change <strong>File Origin</strong> to <code>65001: Unicode (UTF-8)</code>.</li>
                                        <li>Click <strong>Load</strong>. Your Burmese text will now appear correctly.</li>
                                    </ol>
                                    <div class="alert alert-danger py-2 small mt-3">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i> <strong>Important:</strong> When you finish editing, you must <strong>Save As</strong> and select <code>CSV UTF-8 (Comma delimited)</code> to keep the Burmese font working for the upload.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> 
                </div>
                <div class="modal-footer border-0 bg-light">
                    <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            Swal.fire({
                title: 'Welcome to Kobo Patcher!',
                text: 'Please read the Setup Guide carefully before getting started.',
                icon: 'info',
                width: '350px',
                showCancelButton: true,
                confirmButtonColor: '#4e73df',
                cancelButtonColor: '#6e7d88',
                confirmButtonText: 'Open Guide',
                cancelButtonText: 'Later',
                focusConfirm: false,
                allowOutsideClick: false,
                didOpen : () => {
                    const confirmBtn = Swal.getConfirmButton();
                    confirmBtn.blur();
                },
                customClass: {
                    icon: 'small-icon',
                    title: 'fs-5 mt-2',
                    htmlContainer: 'small' 
                }
            }).then((result) => {
                if (result.isConfirmed) {
                   setTimeout(() => {
                        var myModal = new bootstrap.Modal(document.getElementById('guideModal'));
                        myModal.show();
                   },200)
                }
            });
        });

        document.querySelectorAll('.nav-segment button').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.nav-segment button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        async function handleFormSubmit(e, mode) {
            if (e && e.preventDefault) {
                e.preventDefault();
                e.stopImmediatePropagation();
            }

            const form = e.currentTarget || (e instanceof HTMLFormElement ? e : e.target);
            if (!form) return;

            if(!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }

            delete form.dataset.paused;
            if (form.dataset.submitting === 'true') {
                return;
            };
            form.classList.add('was-validated');
            form.dataset.submitting = 'true';
            
            const btn = form.querySelector('button[type="submit"]');
            const originalContent = btn.innerHTML;
            
            let isConfirmed = false;
            let skipUntil = 0;

            try {
                
                while(true) {

                    const form_data = new FormData(form);
                    const fileInput = form.querySelector('input[type="file"]');
                    if (fileInput && fileInput.files[0]) {
                        form_data.set('file', fileInput.files[0]);
                    }
        
                    form_data.set("is_confirmed", isConfirmed ? "true" : "false");
                    form_data.set('skip_until', String(skipUntil));
        
                    console.log("Sending to Backend - isConfirmed:", isConfirmed);
                    btn.disabled = true;
                    btn.innerHTML = '<img src="/static/icons/arrow-repeat.svg" width="18" height="18" class="spin me-2 icon-svg"> Processing...';
                    if (!isConfirmed && skipUntil === 0) {
                        Swal.fire({ 
                            title: 'Processing Data', 
                            html: '<div id="progress-text">Initializing connection...</div>',
                            allowOutsideClick: false,
                            didOpen: () => Swal.showLoading() 
                        });
                    }
                    
                    const response = await fetch(`/${mode}`, { 
                        method: 'POST', 
                        body: form_data
                    });
    
                    if (!response.ok && response.headers.get('content-type')?.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Server Error');
                    }
    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = "";
                    let restart = false;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;
    
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split("\n");
                        buffer = lines.pop();
    
                        for (const line of lines) {
                            const trimmedLine = line.trim();
                            if (!line.trim()) continue;
                                const data = JSON.parse(trimmedLine);
    
                            if (data.status === 'warning') {
                                btn.disabled = false;
                                btn.innerHTML = originalContent;

                                form.dataset.paused = "true";
                                Swal.hideLoading();
                                Swal.update({ title: '', showConfirmButton: false });
                                const progressDiv = document.getElementById('progress-text');
                                delete form.dataset.paused;
                                const result = await showWarningUI(data, progressDiv);
                                console.log("skip until",skipUntil)
                                isConfirmed = result.confirmed;
                                skipUntil = result.skipUntil;

                                restart = true;
                                break;
                            }
                            if (data.status === 'progress') {
                                if(data.is_validation_complete) {
                                    isConfirmed = true;
                                    skipUntil = 0;
                                    restart = true;
                                    await reader.cancel();
                                    break;
                                }
                                Swal.update({
                                    title: 'Processing Data...',
                                    html: `<div id="progress-text" style="min-height: 120px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                            <div class="spinner-border text-success mb-3" role="status"></div>
                                            <div>Finished: <b style="font-size: 1.2em; color: #4e73df;">${data.current}</b> of ${data.total}</div>
                                        </div>`,
                                    showConfirmButton: false
                                });
                            }
                            if (data.status === 'success') {
                                btn.disabled = false;
                                btn.innerHTML = originalContent;

                                let errorSection = "";
                                if (data.err_detail && data.err_detail.length > 0) {
                                    errorSection = `
                                        <div style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
                                            <div class= "text-primary", style="text-align: left; font-size: 0.8rem; font-weight: 600; margin-bottom: 5px;">Issue Details:</div>
                                            <div style="max-height: 120px; overflow-y: auto; overflow-x: hidden; text-align: left; background: #fafafa; border-radius: 4px;">
                                                <table style="width: 100%; border-collapse: collapse; color: #444;">
                                                    <tbody>
                                                        ${data.err_detail.map(err => `
                                                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                                                <td style="padding: 6px 8px; vertical-align: top; width: 20px;">•</td>
                                                                <td style="padding: 6px 8px; line-height: 1.4 !important; font-size: 0.85rem !important;">${err}</td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>`;
                                }

                                Swal.fire({
                                    icon: 'success',
                                    title: 'Import Complete',
                                    html: `
                                        <div style="font-size: 0.9rem; color: #333;">
                                            <p style="margin-bottom: 15px; line-height: 1.4;">${data.message}</p>
                                            ${errorSection}
                                        </div>
                                    `,
                                    confirmButtonText: 'Done',
                                    confirmButtonColor: '#3085d6',
                                    width: '480px',
                                    padding: '1rem'
                                });

                                form.reset();
                                delete form.dataset.paused;
                                form.classList.remove('was-validated');
                                delete form.dataset.submitting;
                                return;
                            }
                            if (data.status === 'error') {
                                Swal.fire({ icon: 'error', title: 'Process Failed', text: data.message });
                                delete form.dataset.submitting;
                                return;
                            }
                        }
                        if (restart) break;
                    }
                    if (!restart) break;
                }

            } catch (err) {
                if (err.message.includes("Field Mismatch")) {
                    const columnList = err.message.split(': ')[1];
                    Swal.fire({
                        icon: 'warning',
                        title: 'CSV Header Mismatch',
                        html: `
                            <div style="text-align: left; font-size: 0.9rem;">
                                <p>The following columns are not recognized by Kobo:</p>
                                <div style="background: #f8f9fa; 
                                            border: 1px solid #dee2e6; 
                                            border-radius: 4px; 
                                            padding: 10px; 
                                            max-height: 150px; 
                                            overflow-y: auto; 
                                            font-family: monospace;
                                            color: #d63384;
                                            word-break: break-all;">
                                    ${columnList}
                                </div>
                            </div>
                        `,
                        confirmButtonText: 'Close & Review',
                        confirmButtonColor: '#f8bb86',
                    });
                }else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Process Failed',
                        text: err.message || 'An unexpected error occurred during validation.',
                        confirmButtonColor: '#d33'
                    });
                }

                if (typeof form !== 'undefined') {
                    delete form.dataset.submitting;
                }

            } finally {
                delete form.dataset.submitting;
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        function showWarningUI(data, progressDiv) {
            return new Promise((resolve) => {

                if (progressDiv) {
                    progressDiv.innerHTML = `
                        <div class="text-center">
                            <div class="text-warning mb-2">
                                <img src="/static/icons/exclamation-triangle.svg" width="30" class="mb-2 filter-warning"><br>
                                <span class="small d-block mx-auto" 
                                    style="max-width: 100%; line-height: 1.4; max-height: 4em; overflow: hidden;">
                                    ${data.message}
                                </span>
                            </div>
                            <div class="d-grid gap-4 d-md-block mt-3">
                                <button type="button" id="continue-btn" class="btn btn-sm btn-warning px-3 text-white">Continue</button>
                                <button type="button" id="confirm-sync-btn" class="btn btn-sm btn-outline-success px-3">Skip All Errors</button>
                            </div>
                        </div>
                    `;
    
                    document.getElementById("continue-btn").onclick = (e) => {
                        const btn = e.target;
                        btn.disabled = true;
                        btn.classList.add('btn-pulse');
                        btn.innerText = "Processing";
                        resolve({
                            confirmed: data.is_validation_complete,
                            skipUntil: data.current
                        });
                    };
    
                    document.getElementById("confirm-sync-btn").onclick = (e) => {
                        const btn = e.target;
                        btn.disabled = true;
                        btn.classList.add('btn-pulse');
                        btn.innerText = "Processing";
                        resolve({
                            confirmed: true,
                            skipUntil: 0
                        });
                    };
                }
            })
        }
    </script>

</body>
</html>